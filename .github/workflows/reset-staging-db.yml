name: Reset Staging Database

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Digite RESET para confirmar o reset do banco de staging"
        required: true
        type: string

jobs:
  reset-staging-db:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Validate confirmation input
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "RESET" ]; then
            echo "::error::ConfirmaÃ§Ã£o invÃ¡lida. Digite 'RESET' para continuar."
            exit 1
          fi
          echo "âœ… ConfirmaÃ§Ã£o recebida: RESET"

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ§¹ Reset staging database volume (safe)
        run: |
          # Use quoted heredoc to avoid local variable expansion
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            echo "ğŸ“ Host: $(hostname)"
            echo "ğŸ“‚ Checking volumes before reset..."
            docker volume ls || true

            # Ensure network exists
            docker network create projetogran_crewflow-network 2>/dev/null || true

            cd /opt/projetogran
            if [ ! -f docker-compose.staging.yml ]; then
              echo "âŒ docker-compose.staging.yml not found in /opt/projetogran"
              exit 1
            fi

            echo "ğŸ›‘ Bringing down staging stack..."
            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
              $COMPOSE_CMD -f docker-compose.staging.yml down || true
            else
              echo "â„¹ï¸ Using containerized docker-compose (v1.29.2) fallback for 'down'"
              COMPOSE_RUN="docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /opt/projetogran:/workdir -w /workdir docker/compose:1.29.2"
              $COMPOSE_RUN -f docker-compose.staging.yml down || true
            fi

            echo "ğŸ›¡ï¸ Safety check: do NOT touch production volume"
            if docker volume inspect postgres_data >/dev/null 2>&1; then
              echo "â„¹ï¸ Production volume 'postgres_data' exists (will NOT be removed)"
            fi

            echo "ğŸ—‘ï¸ Removing staging DB volume 'postgres_data_staging'"
            if docker volume inspect postgres_data_staging >/dev/null 2>&1; then
              docker volume rm postgres_data_staging
            else
              echo "â„¹ï¸ Volume 'postgres_data_staging' not found (nothing to remove)"
            fi

            echo "ğŸš€ Recreating staging stack..."
            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
              $COMPOSE_CMD -f docker-compose.staging.yml up -d
            else
              echo "â„¹ï¸ Using containerized docker-compose (v1.29.2) fallback for 'up'"
              COMPOSE_RUN="docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /opt/projetogran:/workdir -w /workdir docker/compose:1.29.2"
              $COMPOSE_RUN -f docker-compose.staging.yml up -d
            fi

            echo "â³ Waiting for PostgreSQL (staging) to be ready..."
            sleep 10

            echo "ğŸ§­ Running Prisma migrations and seed on staging app..."
            if docker ps | grep -q "crewflow-app-staging"; then
              docker exec crewflow-app-staging npx prisma migrate deploy || true
              if docker exec crewflow-app-staging npx prisma db seed 2>/dev/null; then
                echo "âœ… Staging database seeded successfully"
              else
                echo "â„¹ï¸ Seed skipped (database already populated or error occurred)"
              fi
            else
              echo "âŒ Staging app container not running"
              docker ps
              exit 1
            fi

            echo "ğŸ” Checking volumes after reset..."
            docker volume ls || true

            echo "ğŸ” Health check on staging /login..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/login || echo "000")
            echo "HTTP status: $STATUS"
            case "$STATUS" in
              200|302|307|308)
                echo "âœ… Staging app responding on /login"
                ;;
              *)
                echo "âŒ Unexpected status on /login: $STATUS"
                docker logs crewflow-app-staging 2>/dev/null || true
                exit 1
                ;;
            esac
          EOF

      - name: ğŸ‰ Reset complete
        run: |
          echo "ğŸš€ Staging DB reset completed successfully!"
          echo "ğŸŒ Staging app: http://${{ secrets.SERVER_HOST }}:3002/login"
          echo "ğŸ—„ï¸ Staging Postgres port: 5435"
          echo "ğŸ§° Staging pgAdmin: http://${{ secrets.SERVER_HOST }}:5051"