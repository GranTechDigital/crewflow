name: Deploy CrewFlow to Staging

on:
  push:
    branches: [ develop, staging ]
  pull_request:
    branches: [ main ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: üîß Build Docker image
      run: |
        docker build --no-cache -t crewflow-app:staging .
        
    - name: üíæ Save Docker image
      run: |
        docker save crewflow-app:staging > crewflow-app-staging.tar
        
    - name: üîë Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: üì§ Upload image to server
      run: |
        # Clean up any existing staging tar file first
        ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} "rm -f /tmp/crewflow-app-staging.tar"
        
        # Upload new image
        scp -o StrictHostKeyChecking=no crewflow-app-staging.tar root@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ensure application directory exists and upload staging Postgres compose
        ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} "mkdir -p /opt/projetogran"
        scp -o StrictHostKeyChecking=no docker-compose.staging-postgres.yml root@${{ secrets.SERVER_HOST }}:/opt/projetogran/
        
    - name: üöÄ Deploy to staging
      run: |
        ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          # Clean up Docker system before deployment
          docker system prune -f || true

          # Load new image
          docker load < /tmp/crewflow-app-staging.tar

          # Ensure Postgres staging is up via compose
          docker network create projetogran_crewflow-network 2>/dev/null || true
          cd /opt/projetogran
          docker rm -f postgres-staging 2>/dev/null || true
          if docker compose version >/dev/null 2>&1; then
            docker compose -f /opt/projetogran/docker-compose.staging-postgres.yml down || true
            docker compose -f /opt/projetogran/docker-compose.staging-postgres.yml up -d
          else
            echo "‚ÑπÔ∏è Docker Compose v2 not found. Installing plugin..."
            ARCH=$(uname -m)
            COMPOSE_URL=""
            if [ "$ARCH" = "x86_64" ]; then
              COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64"
            elif [ "$ARCH" = "aarch64" ]; then
              COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-aarch64"
            elif [ "$ARCH" = "armv7l" ]; then
              COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-armv7"
            else
              echo "‚ùå Unsupported architecture: $ARCH"
              uname -a || true
              exit 125
            fi
            mkdir -p ~/.docker/cli-plugins
            if command -v curl >/dev/null 2>&1; then
              curl -fsSL "$COMPOSE_URL" -o ~/.docker/cli-plugins/docker-compose
            elif command -v wget >/dev/null 2>&1; then
              wget -qO ~/.docker/cli-plugins/docker-compose "$COMPOSE_URL"
            else
              echo "‚ùå Neither curl nor wget is available to download Docker Compose."
              exit 125
            fi
            chmod +x ~/.docker/cli-plugins/docker-compose
            if docker compose version >/dev/null 2>&1; then
              echo "‚úÖ Docker Compose v2 installed."
            else
              echo "‚ùå Failed to install Docker Compose v2."
              exit 125
            fi
            docker compose -f /opt/projetogran/docker-compose.staging-postgres.yml down || true
            docker compose -f /opt/projetogran/docker-compose.staging-postgres.yml up -d
          fi

          # Stop and remove old staging container
          docker stop crewflow-app-staging 2>/dev/null || true
          docker rm crewflow-app-staging 2>/dev/null || true

          # Start new staging container (different port, correct internal port)
          docker run -d --name crewflow-app-staging \
            --network projetogran_crewflow-network \
            -p 3002:3001 \
            -e DATABASE_URL='postgresql://postgres:senha_segura_aqui@postgres-staging:5432/projetogran?schema=public' \
            -e JWT_SECRET='crewflow-jwt-secret-staging-2024' \
            -e NEXTAUTH_URL='http://${{ secrets.SERVER_HOST }}:3002' \
            -e NODE_ENV='production' \
            crewflow-app:staging

          # Clean up
          rm /tmp/crewflow-app-staging.tar

          # Wait for container to start
          sleep 10

          # Check if container is running
          if docker ps | grep -q crewflow-app-staging; then
            echo "‚úÖ Staging container started successfully"
          else
            echo "‚ùå Staging container failed to start"
            docker logs crewflow-app-staging
            exit 1
          fi

          # Setup Prisma inside container (fail on error)
          docker exec crewflow-app-staging npx prisma generate
          # Hotfix: ensure migration_lock provider matches Postgres before migrating
          docker exec crewflow-app-staging sh -lc "if grep -q 'provider = \"sqlite\"' prisma/migrations/migration_lock.toml; then echo '‚ö†Ô∏è Fixing migration_lock provider from sqlite to postgresql'; printf '# Please do not edit this file manually\n# It should be added in your version-control system (e.g., Git)\nprovider = \"postgresql\"\n' > prisma/migrations/migration_lock.toml; fi; echo 'üîé Current migration_lock:'; cat prisma/migrations/migration_lock.toml"

          # Mark legacy SQLite migrations as applied (do not run them)
          echo "ü©π Reconciling legacy SQLite migrations (rolled-back if failed, then applied)..."
          # First mark as rolled-back if there is a failed record; safe to ignore errors
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250902123443_add_data_vencimento" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250903112552_add_uptime_upload_model" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250903133325_create_uptime_sheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250903151921_remove_uptime_sheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250903162029_create_uptime_sheet_columns" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250904121815_ajuste_relacao_uptimesheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250917113538_create_downtime_sheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250918184957_add_periodo_columns" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250919132509_add_data_relatorio_uptime_upload" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250919150416_create_periodo_tables" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250923112622_create_status_mapping" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250924144015_add_regime_trabalho_and_ids_mapping" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250925124643_add_planilha_columns" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250925130000_create_funcoes_table" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250926171502_add_nome_centro_custo" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250928145113_add_centro_custo_to_periodo_sheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250930135019_create_treinamentos_table_force" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20250930142329_update_treinamentos_fields" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20251001160518_create_matriz_treinamento" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --rolled-back "20251001192820_make_treinamento_optional" || true

          # Then mark as applied to prevent Prisma from trying to run their SQL
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250902123443_add_data_vencimento" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250903112552_add_uptime_upload_model" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250903133325_create_uptime_sheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250903151921_remove_uptime_sheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250903162029_create_uptime_sheet_columns" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250904121815_ajuste_relacao_uptimesheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250917113538_create_downtime_sheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250918184957_add_periodo_columns" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250919132509_add_data_relatorio_uptime_upload" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250919150416_create_periodo_tables" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250923112622_create_status_mapping" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250924144015_add_regime_trabalho_and_ids_mapping" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250925124643_add_planilha_columns" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250925130000_create_funcoes_table" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250926171502_add_nome_centro_custo" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250928145113_add_centro_custo_to_periodo_sheet" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250930135019_create_treinamentos_table_force" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20250930142329_update_treinamentos_fields" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20251001160518_create_matriz_treinamento" || true
          docker exec crewflow-app-staging npx prisma migrate resolve --applied "20251001192820_make_treinamento_optional" || true

          # Now apply Postgres migrations
          docker exec crewflow-app-staging npx prisma migrate deploy
          
          # Run seed to populate staging database (idempotent, but surface errors)
          echo "üå± Running seed:complete on staging database..."
          docker exec crewflow-app-staging npm run seed:complete
          
          # Verify tables exist
          echo "üîé Verificando tabelas no banco..."
          docker exec postgres-staging psql -U postgres -d projetogran -c "\dt"
        EOF
        
    - name: üß™ Run tests (optional)
      run: |
        ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF'
          # Basic health check
          sleep 5
          if curl -f http://localhost:3002/api/health 2>/dev/null; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è Health check failed (normal if no health endpoint)"
          fi
        EOF
        
    - name: üìù Comment PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `üöÄ **CrewFlow Staging Deploy Successful!**
            
            üìç **Staging URL:** http://${{ secrets.SERVER_HOST }}:3002
            üîê **Login:** ADMIN001 / admin123
            
            ‚úÖ Ready for testing!`
          })
        
    - name: üéâ Staging deployment complete
      run: |
        echo "üöÄ CrewFlow staging deployment completed successfully!"
        echo "üåê Staging available at: http://${{ secrets.SERVER_HOST }}:3002"
        echo "üîê Login: ADMIN001 / admin123"