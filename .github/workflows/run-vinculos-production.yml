name: Run Vincular Funcionarios â†” Contratos (Production)

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/run-vinculos-production.yml'
      - 'scripts/vincular-funcionarios-contratos.js'
  workflow_dispatch:
    inputs:
      excel_path:
        description: 'Caminho do Excel no servidor (ex.: /opt/projetogran/data/vinculos.xlsx)'
        type: string
        required: false
        default: '/opt/projetogran/data/vinculos.xlsx'

jobs:
  vincular:
    environment: production
    runs-on: ubuntu-latest
    steps:
      - name: â™»ï¸ Trigger marker
        run: |
          echo "Run iniciado em $(date -u +%Y-%m-%dT%H:%M:%SZ)"
      - name: ðŸ”‘ Setup SSH
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.PROD_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ PROD_SSH_PRIVATE_KEY secret nÃ£o estÃ¡ configurado"; exit 1; fi
          if [ -z "${{ secrets.PROD_SERVER_HOST }}" ]; then
            echo "âŒ PROD_SERVER_HOST secret nÃ£o estÃ¡ configurado"; exit 1; fi
          PORT="${{ secrets.PROD_SERVER_SSH_PORT }}"; [ -z "$PORT" ] && PORT=22
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          printf 'Host %s\n  Port %s\n  User root\n  StrictHostKeyChecking no\n' "${{ secrets.PROD_SERVER_HOST }}" "$PORT" >> ~/.ssh/config
          set +e
          ssh-keyscan -p "$PORT" -T 5 -H "${{ secrets.PROD_SERVER_HOST }}" >> ~/.ssh/known_hosts
          set -e

      - name: ðŸ”— Vincular funcionÃ¡rios aos contratos (produÃ§Ã£o)
        run: |
          set -euo pipefail
          HOST="${{ secrets.PROD_SERVER_HOST }}"
          PORT="${{ secrets.PROD_SERVER_SSH_PORT }}"; [ -z "$PORT" ] && PORT=22
          EXCEL_PATH_INPUT="${{ github.event.inputs.excel_path }}"
          [ -z "$EXCEL_PATH_INPUT" ] && EXCEL_PATH_INPUT="/opt/projetogran/data/vinculos.xlsx"

          echo "ðŸ”Ž Host: $HOST"
          echo "ðŸ”Ž Excel (server path): $EXCEL_PATH_INPUT"
          
          # Passar variÃ¡vel EXCEL_PATH_INPUT para o shell remoto sem expandir o restante do script local
          ssh -p "$PORT" -o StrictHostKeyChecking=no root@"$HOST" "EXCEL_PATH_INPUT='$EXCEL_PATH_INPUT' bash -s" << 'EOF'
            set -e
            EXCEL_PATH="$EXCEL_PATH_INPUT"
            APP_CONT="crewflow-app-production"
            echo "ðŸ“ Garantindo diretÃ³rios de trabalho"
            mkdir -p /opt/projetogran/data || true
            mkdir -p /opt/projetogran/relatorios || true
            if [ ! -f "$EXCEL_PATH" ]; then
              echo "âŒ Arquivo Excel nÃ£o encontrado: $EXCEL_PATH"; exit 1; fi
            ls -lh "$EXCEL_PATH" || true

            echo "ðŸ“ Garantindo diretÃ³rio /app/data dentro do container"
            docker exec "$APP_CONT" sh -lc 'mkdir -p /app/data'

            echo "ðŸ“¥ Copiando Excel para dentro do container"
            docker cp "$EXCEL_PATH" "$APP_CONT":/app/data/vinculos.xlsx
            docker exec "$APP_CONT" sh -lc 'ls -lh /app/data/vinculos.xlsx'

            echo "ðŸ”Ž Contagem de funcionÃ¡rios com contratoId (ANTES)"
            docker exec postgres-prod bash -lc 'export PGPASSWORD="$POSTGRES_PASSWORD"; psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -tAc "select count(*) from \"Funcionario\" where \"contratoId\" is not null;"'

            echo "ðŸš€ Executando script de vÃ­nculo dentro do container"
            docker exec "$APP_CONT" node scripts/vincular-funcionarios-contratos.js /app/data/vinculos.xlsx

            echo "ðŸ”Ž Contagem de funcionÃ¡rios com contratoId (DEPOIS)"
            docker exec postgres-prod bash -lc 'export PGPASSWORD="$POSTGRES_PASSWORD"; psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -tAc "select count(*) from \"Funcionario\" where \"contratoId\" is not null;"'

            echo "ðŸ“¤ Copiando relatÃ³rio gerado para o servidor"
            if docker exec "$APP_CONT" test -f /app/relatorio-vinculos-funcionarios.xlsx; then
              docker cp "$APP_CONT":/app/relatorio-vinculos-funcionarios.xlsx /opt/projetogran/relatorios/relatorio-vinculos-funcionarios.xlsx
              ls -lh /opt/projetogran/relatorios/relatorio-vinculos-funcionarios.xlsx || true
            else
              echo "â„¹ï¸ RelatÃ³rio nÃ£o encontrado no container (pode ter falhado)"
              exit 1
            fi
          EOF

      - name: ðŸ“¦ Upload do relatÃ³rio (se existir)
        if: ${{ always() }}
        run: |
          set -euo pipefail
          HOST="${{ secrets.PROD_SERVER_HOST }}"
          PORT="${{ secrets.PROD_SERVER_SSH_PORT }}"; [ -z "$PORT" ] && PORT=22
          ssh -p "$PORT" -o StrictHostKeyChecking=no root@"$HOST" 'set -e; ls -lh /opt/projetogran/relatorios/relatorio-vinculos-funcionarios.xlsx 2>/dev/null || true'